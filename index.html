<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLBB Diamond Tracker</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        :root { --bg: #0b0e14; --card: #161b22; --blue: #00d2ff; --green: #39ff14; --text: #ffffff; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; text-align: center; }
        .container { max-width: 500px; margin: auto; display: none; padding-top: 20px; }
        #login-screen { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .btn { background: var(--blue); color: #000; border: none; padding: 12px; border-radius: 5px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; }
        input, select { width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: 1px solid #444; box-sizing: border-box; }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
        .card { background: var(--card); padding: 15px; border-radius: 10px; border: 1px solid #333; }
        .list-item { background: #111; padding: 10px; border-radius: 5px; margin-bottom: 5px; text-align: left; font-size: 13px; border-left: 3px solid var(--blue); }
    </style>
</head>
<body>

<div id="login-screen">
    <h2 style="color: var(--blue);">ğŸ’ Dia Seller Tracker ğŸ’</h2>
    <p>á€†á€€á€ºá€œá€¯á€•á€ºá€›á€”á€º Google á€”á€¾á€„á€·á€º Login á€á€„á€ºá€•á€«</p>
    <button class="btn" style="background:#db4437; color:white;" onclick="login()">Login with Google</button>
</div>

<div class="container" id="main-container">
    <div style="display:flex; justify-content: space-between; font-size: 12px; color: #888;">
        <span id="userEmail"></span>
        <span onclick="logout()" style="color:red; cursor:pointer;">Logout</span>
    </div>
    
    <h3 style="color: var(--blue);">á€…á€­á€”á€ºá€…á€¬á€›á€„á€ºá€¸ á€á€½á€„á€ºá€¸á€›á€”á€º</h3>
    <input type="number" id="scRate" placeholder="Sc Rate (á€¥á€•á€™á€¬ 75.8)" value="75.8" oninput="updateBuyPrice()">
    <input type="date" id="saleDate">
    <select id="packageSelect" onchange="updateBuyPrice()"></select>
    <input type="number" id="sellPrice" placeholder="á€›á€±á€¬á€„á€ºá€¸á€ˆá€±á€¸ (á€€á€»á€•á€º)">
    <input type="hidden" id="buyPrice">
    <button class="btn" onclick="addRecord()">Cloud á€á€­á€¯á€· á€á€­á€™á€ºá€¸á€™á€Šá€º</button>

    <div class="dashboard">
        <div class="card"><h4>á€šá€”á€±á€·á€¡á€™á€¼á€á€º</h4><p id="totalProfit" style="color:var(--green)">0</p></div>
        <div class="card"><h4>á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸</h4><p id="overallProfit" style="color:var(--green)">0</p></div>
    </div>
    
    <div id="tableContent"></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAe7CMFx0eLZmJ6PGNsvLyAjtude_sbqvw", 
        authDomain: "diamond-sales-fcb29.firebaseapp.com",
        projectId: "diamond-sales-fcb29",
        storageBucket: "diamond-sales-fcb29.firebasestorage.app",
        messagingSenderId: "928447803826",
        appId: "1:928447803826:web:c09e7fc3b50d544b2ab4ab"
    };
    
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    
    const db = firebase.firestore();
    const auth = firebase.auth();

    const packages = [
        { name: "86 Dia", sc: 61.5 }, { name: "172 Dia", sc: 122 }, { name: "257 Dia", sc: 177.5 },
        { name: "429 Dia", sc: 299.5 }, { name: "Weekly Pass", sc: 76 }
    ];

    const sel = document.getElementById('packageSelect');
    packages.forEach(p => { sel.innerHTML += `<option value="${p.name}">${p.name}</option>`; });

    // Login Function (Error á€•á€¼á€•á€±á€¸á€™á€Šá€·á€º á€…á€”á€…á€ºá€•á€«á€á€„á€ºá€á€Šá€º)
    function login() { 
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithRedirect(provider).catch(function(error) {
            alert("Login á€™á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«: " + error.message);
        });
    }

    // Redirect á€€á€”á€± á€•á€¼á€”á€ºá€¡á€œá€¬ Error á€›á€¾á€­á€™á€›á€¾á€­ á€…á€…á€ºá€†á€±á€¸á€á€¼á€„á€ºá€¸
    auth.getRedirectResult().catch(function(error) {
        alert("Authentication Error: " + error.message);
    });

    function logout() { auth.signOut(); }

    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-container').style.display = 'block';
            document.getElementById('userEmail').innerText = user.email;
            loadData(user.uid);
        } else {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('main-container').style.display = 'none';
        }
    });

    function updateBuyPrice() {
        const rate = parseFloat(document.getElementById('scRate').value) || 0;
        const pkg = packages.find(p => p.name === sel.value);
        if(pkg) document.getElementById('buyPrice').value = Math.round(pkg.sc * rate);
    }

    updateBuyPrice(); 

    async function addRecord() {
        const date = document.getElementById('saleDate').value;
        const buy = parseFloat(document.getElementById('buyPrice').value);
        const sell = parseFloat(document.getElementById('sellPrice').value);
        
        if(!date || !sell || isNaN(buy) || buy === 0) return alert("á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸á€€á€­á€¯ á€•á€¼á€Šá€·á€ºá€…á€¯á€¶á€™á€¾á€”á€ºá€€á€”á€ºá€…á€½á€¬ á€–á€¼á€Šá€·á€ºá€•á€«");

        await db.collection("sales").add({
            userId: auth.currentUser.uid, 
            date, 
            pkg: sel.value, 
            buy, 
            sell, 
            profit: sell - buy,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('sellPrice').value = "";
        alert("á€…á€¬á€›á€„á€ºá€¸á€á€½á€„á€ºá€¸á€•á€¼á€®á€¸á€•á€«á€•á€¼á€®");
    }

    function loadData(uid) {
        db.collection("sales").where("userId", "==", uid).onSnapshot(snap => {
            let tProfit = 0, oProfit = 0, html = "";
            
            const d = new Date();
            const today = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            
            let records = [];
            snap.forEach(doc => { records.push(doc.data()); });

            records.sort((a, b) => new Date(b.date) - new Date(a.date));

            records.forEach(s => {
                oProfit += s.profit;
                if(s.date === today) tProfit += s.profit;
                html += `<div class="list-item">ğŸ“… ${s.date} | ğŸ’ ${s.pkg}<br>ğŸ’° á€¡á€™á€¼á€á€º: ${s.profit.toLocaleString()} á€€á€»á€•á€º</div>`;
            });
            
            document.getElementById('totalProfit').innerText = tProfit.toLocaleString();
            document.getElementById('overallProfit').innerText = oProfit.toLocaleString();
            document.getElementById('tableContent').innerHTML = html;
        });
    }
    
    document.getElementById('saleDate').valueAsDate = new Date();
</script>
</body>
</html>